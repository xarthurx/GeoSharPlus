name: GeoSharPlus CI

on:
  push:
    branches: [ main, master, develop, template-cleanup ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  # ============================================
  # Build and Test .NET Projects (No C++ dependency)
  # ============================================
  # This job tests the Core and Geometry classes which don't require
  # the native C++ library. The generated FlatBuffer files are 
  # already checked into the repository.
  # ============================================
  test-dotnet-core:
    name: Test .NET Core (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Verify generated FlatBuffer files exist
      shell: bash
      run: |
        echo "Checking for generated FlatBuffer files..."
        if [ -d "generated/GSP_FB/csharp" ]; then
          echo "? Found generated/GSP_FB/csharp/"
          ls -la generated/GSP_FB/csharp/
          file_count=$(ls -1 generated/GSP_FB/csharp/*.cs 2>/dev/null | wc -l)
          echo "Found $file_count generated C# files"
          if [ "$file_count" -lt 1 ]; then
            echo "? No .cs files found in generated/GSP_FB/csharp/"
            exit 1
          fi
        else
          echo "? Missing generated/GSP_FB/csharp/ directory"
          echo "Please run the FlatBuffer compiler locally and commit the generated files."
          exit 1
        fi

    - name: Restore dependencies
      run: dotnet restore GeoSharPlusNET.Tests/GeoSharPlusNET.Tests.csproj

    - name: Build test project
      run: dotnet build GeoSharPlusNET.Tests/GeoSharPlusNET.Tests.csproj --configuration Release --no-restore

    - name: Run tests
      run: dotnet test GeoSharPlusNET.Tests/GeoSharPlusNET.Tests.csproj --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}
        path: '**/TestResults/*.trx'

  # ============================================
  # Build Full .NET Solution (Windows only)
  # ============================================
  # This requires RhinoCommon which is only available as reference assemblies.
  # ============================================
  build-dotnet-full:
    name: Build .NET Solution
    runs-on: windows-latest
    needs: test-dotnet-core

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore GeoSharPlusNET
      run: dotnet restore GeoSharPlusNET/GeoSharPlusNET.csproj

    - name: Build GeoSharPlusNET (Release)
      run: dotnet build GeoSharPlusNET/GeoSharPlusNET.csproj --configuration Release --no-restore

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: GeoSharPlusNET-build
        path: GeoSharPlusNET/bin/Release/

  # ============================================
  # Build C++ Library (Windows)
  # ============================================
  # This job builds the native C++ library using CMake and vcpkg.
  # Note: This may fail if specific VS toolset versions are required.
  # ============================================
  build-cpp-windows:
    name: Build C++ (Windows)
    runs-on: windows-latest
    continue-on-error: true  # Don't fail the whole workflow if C++ build fails

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: 'a42af01b72c28a8e1d7b48107b33e4f286a55ef6'
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'

    - name: Cache vcpkg packages
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/vcpkg/installed
          ${{ github.workspace }}/GeoSharPlusCPP/build/vcpkg_installed
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('GeoSharPlusCPP/vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-

    - name: Configure CMake
      run: |
        cmake -S GeoSharPlusCPP -B GeoSharPlusCPP/build -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          -DVCPKG_TARGET_TRIPLET=x64-windows
      env:
        VCPKG_ROOT: ${{ github.workspace }}/vcpkg

    - name: Build C++
      run: cmake --build GeoSharPlusCPP/build --config Release

    - name: Upload C++ artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: cpp-windows-build
        path: |
          GeoSharPlusCPP/build/Release/*.dll
          GeoSharPlusCPP/build/Release/*.lib
          cppPrebuild/*.dll

  # ============================================
  # Build C++ Library (macOS)
  # ============================================
  build-cpp-macos:
    name: Build C++ (macOS)
    runs-on: macos-latest
    continue-on-error: true  # Don't fail the whole workflow if C++ build fails

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: 'a42af01b72c28a8e1d7b48107b33e4f286a55ef6'
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'

    - name: Cache vcpkg packages
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/vcpkg/installed
          ${{ github.workspace }}/GeoSharPlusCPP/build/vcpkg_installed
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('GeoSharPlusCPP/vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-

    - name: Configure CMake
      run: |
        cmake -S GeoSharPlusCPP -B GeoSharPlusCPP/build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" \
          -DVCPKG_TARGET_TRIPLET=x64-osx
      env:
        VCPKG_ROOT: ${{ github.workspace }}/vcpkg

    - name: Build C++
      run: cmake --build GeoSharPlusCPP/build --config Release

    - name: Upload C++ artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: cpp-macos-build
        path: |
          GeoSharPlusCPP/build/*.dylib
          cppPrebuild/*.dylib

  # ============================================
  # Test Coverage Report
  # ============================================
  coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    needs: test-dotnet-core

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore GeoSharPlusNET.Tests/GeoSharPlusNET.Tests.csproj

    - name: Run tests with coverage
      run: |
        dotnet test GeoSharPlusNET.Tests/GeoSharPlusNET.Tests.csproj \
          --configuration Release \
          --collect:"XPlat Code Coverage" \
          --results-directory ./coverage

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/**/coverage.cobertura.xml

  # ============================================
  # Generate FlatBuffer Files (Manual trigger only)
  # ============================================
  # This job can regenerate FlatBuffer files if schemas change.
  # Triggered manually via workflow_dispatch.
  # ============================================
  generate-flatbuffers:
    name: Generate FlatBuffers
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install FlatBuffers compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y flatbuffers-compiler
        flatc --version

    - name: Generate C# files
      run: |
        mkdir -p generated/GSP_FB/csharp
        for schema in GeoSharPlusCPP/schema/*.fbs; do
          echo "Generating C# from $schema..."
          flatc --csharp --gen-object-api --scoped-enums -o generated/GSP_FB/csharp "$schema"
        done
        echo "Generated files:"
        ls -la generated/GSP_FB/csharp/

    - name: Generate C++ files
      run: |
        mkdir -p generated/GSP_FB/cpp
        for schema in GeoSharPlusCPP/schema/*.fbs; do
          echo "Generating C++ from $schema..."
          flatc --cpp --scoped-enums -o generated/GSP_FB/cpp "$schema"
        done
        echo "Generated files:"
        ls -la generated/GSP_FB/cpp/

    - name: Upload generated files
      uses: actions/upload-artifact@v4
      with:
        name: generated-flatbuffers
        path: generated/GSP_FB/
